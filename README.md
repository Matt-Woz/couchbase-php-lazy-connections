# Couchbase SDK PHP Lazy Connection Test Harness

This repository contains a small, reproducible test harness for measuring how the
Couchbase PHP SDK behaves under lazy connection mode using different configurations, concurrency levels, and
bootstrap/operation node choices.
---

## Setup

### Server Node/Document ID Configuration (config/nodes.json)
This file maps:
```
{
"NODE_IP": "DOCUMENT_ID"
}
```

Example:
```
{
"192.168.106.128": "100000",
"192.168.106.129": "A00000",
"192.168.106.130": "c00000",
"192.168.106.131": "110000"
}
```
These document IDs are chosen so each ID is owned by a specific KV node in the cluster.

By default, the orchestrator uses a bucket called 'default' using the default scope/collection.

These IDs should already exist in the cluster before running the tests, they can be
generated by a tool like [cbc-keygen](https://github.com/couchbase/couchbase-cxx-client/tree/main/tools). For example:

```
$ ./cbc keygen --vbuckets-for-nodes=active --json --number-of-keys=1 --bucket-name=default --connection-string=couchbase://192.168.106.130
{
  "192.168.106.128:11207": [
    "100000"
  ],
  "192.168.106.129:11207": [
    "A00000"
  ],
  "192.168.106.130:11207": [
    "c00000"
  ],
  "192.168.106.131:11207": [
    "110000"
  ]
}
```

The docker-compose file is configured to work with the `dinonet` network, which is the default for
[cbdinocluster](https://github.com/couchbaselabs/cbdinocluster). If your cluster is on a different network or elsewhere, modify the network configuration as needed.

### Experiment Configuration (config/experiments.json)

The orchestrator runs a series of experiments, captures KV connection counts before/after, and writes results to `results/<timestamp>/`.

An experiment entry looks like this:

```
  {
    "name": "operation_on_different_node_from_bootstrap",
    "bootstrap_node": [0, 1, 2, 3],
    "op_nodes": "not_bootstrap",
    "op": "get",
    "bucket": "default",
    "concurrency_levels": [1, 100, 300]
  }
```
You can modify or add new experiments within the experiments json file.

The fields are as follows:
- `name`: A unique name for the experiment.
- `bootstrap_node`: Array of node indexes to randomly select to bootstrap from (refers to the order in `nodes.json`).
- `op_nodes`: Comma-separated list of node indices to target for operations (refers to the order in `nodes.json`), or special options:
  - `bootstrap` - use the same node as bootstrap
  - `not_bootstrap` - use any node that is not the bootstrap node
  - `all` - use all nodes
  - `none` - do not perform any operations
- `op`: The KV operation to perform. Possible values: `'get'`, `'none'`.
- `bucket`: The bucket name to connect to, defaults to `default`. The scope/collection is always `_default._default`.
- `concurrency_levels`: Array of concurrency levels to test.

### PHP-FPM Worker Configuration (src/php-fpm.conf)

The file src/php-fpm.conf can be configured for regular PHP-FPM settings, such as the number of workers.

## Running Experiments

Once everything is configured, run docker-compose to start the PHP environment:

```
docker compose up
```
and once that is running, run the orchestrator script:
```
php scripts/orchestrator.php
```

This will execute all experiments defined in `config/experiments.json`, capturing KV connection counts
before and after each experiment, and writing results to `results/<timestamp>/`. It will also
attempt to plot charts for each experiment in `results/<timestamp>/charts`. Note that python and matplotlib must be installed.
